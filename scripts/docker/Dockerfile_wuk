# syntax=docker/dockerfile:1.4
FROM ubuntu:noble
WORKDIR /workspace
VOLUME /workspace
ARG WUK_INSTALL_PREFIX=/workspace/HFuse_build
COPY . /workspace/HFuse/
RUN <<EOF

apt-get update -y
apt-get upgrade -y
apt-get install --no-install-recommends -y \
    clang llvm-dev libclang-dev cmake ninja-build
apt-get autoremove -y
apt-get clean -y
rm -rf /var/lib/apt/lists/*

rm -rf ${WUK_INSTALL_PREFIX}
cd /workspace/HFuse
cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DCMAKE_PREFIX_PATH="$(llvm-config --cmakedir);$(llvm-config --cmakedir)../clang" \
    -DCMAKE_INSTALL_PREFIX=${WUK_INSTALL_PREFIX} \
    -B ${WUK_INSTALL_PREFIX}/build
cmake --build ${WUK_INSTALL_PREFIX}/build -j
cmake --build ${WUK_INSTALL_PREFIX}/build -t install

EOF
